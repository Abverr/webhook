<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Лог сделок HR</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { padding: 10px 20px; margin-bottom: 15px; border-radius: 6px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
    pre { background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 600px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>Лог сделок (JSON)</h2>
  <button onclick="loadDeals()">Показать JSON</button>
  <pre id="output">Нажмите кнопку, чтобы получить данные...</pre>

<script>
  async function loadDeals() {
    const output = document.getElementById("output");
    output.textContent = "Загрузка...";

    try {
      const webhookDeals = "https://dnk-labtest.bitrix24.ru/rest/1/lsobaw3e7d8b2c1c/crm.deal.list.json";
      const webhookUser = "https://dnk-labtest.bitrix24.ru/rest/1/wgpekxa1mk1ht13w/user.get.json";

      // 1. Получаем список сделок
      const resDeals = await fetch(webhookDeals);
      const dataDeals = await resDeals.json();
      if (!dataDeals.result) {
        output.textContent = "Нет данных или ошибка вебхука";
        return;
      }

      // 2. Получаем список пользователей
      const resUsers = await fetch(webhookUser);
      const dataUsers = await resUsers.json();
      const users = {};
      dataUsers.result.forEach(user => {
        users[user.ID] = user.NAME + ' ' + user.LAST_NAME;
      });

      // 3. Формируем результат
   const result = {};
dataDeals.result.forEach(deal => {
  const dealId = deal.ID;
  if (!result[dealId]) result[dealId] = {};

  result[dealId][deal.STAGE_ID] = {
    user_id: deal.ASSIGNED_BY_ID,
    user_name: users[deal.ASSIGNED_BY_ID] || deal.ASSIGNED_BY_ID,
    date_time: deal.DATE_MODIFY
  };
});


      output.textContent = JSON.stringify(result, null, 2);

    } catch (err) {
      output.textContent = "Ошибка: " + err;
    }
  }
</script>
</body>
</html>
